# rhydlewis/search-omnifocus

 from \_\_future\_\_ import unicode\_literals from omnifocus import DEFAULT\_OF\_VERSION ID = str\("id"\) NAME = str\("name"\) BLOCKED\_BY\_START\_DATE = str\("blocked\_by\_future\_start\_date"\) PROJECT\_NAME = str\("project\_name"\) START\_DATE = str\("start\_date"\) IN\_INBOX = str\("in\_inbox"\) EFFECTIVE\_IN\_INBOX = str\("effective\_in\_inbox"\) EFFECTIVE\_START\_DATE = str\("effective\_start\_date"\) CHILD\_COUNT = str\("child\_count"\) BLOCKED = str\("blocked"\) STATUS = str\("status"\) DUE\_DATE = str\("due\_date"\) AVAILABLE\_TASK\_COUNT = str\("available\_task\_count"\) REMAINING\_TASK\_COUNT = str\("remaining\_task\_count"\) SINGLETON = str\("singleton"\) FOLDER\_NAME = str\("folder\_name"\) ALLOWS\_NEXT\_ACTION = str\("allows\_next\_action"\) CONTAINING\_PROJECT\_INFO = str\("parent"\) MODIFIED\_DATE = str\("modified"\) PROJECT\_IS\_REMAINING = str\("project\_remaining"\) NAME\_SORT = "name ASC" TASK\_SELECT = ", ".join\(\[ "t.persistentIdentifier AS {0}".format\(ID\), "t.name AS {0}".format\(NAME\), "t.dateCompleted", "t.blockedByFutureStartDate AS {0}".format\(BLOCKED\_BY\_START\_DATE\), "p.name AS {0}".format\(PROJECT\_NAME\), "t.flagged", "t.dateToStart AS {0}".format\(START\_DATE\), "t.inInbox AS {0}".format\(IN\_INBOX\), "t.effectiveInInbox AS {0}".format\(EFFECTIVE\_IN\_INBOX\), "t.effectiveDateToStart AS {0}".format\(EFFECTIVE\_START\_DATE\), "t.childrenCountAvailable AS {0}".format\(CHILD\_COUNT\), "t.blocked AS {0}".format\(BLOCKED\), "pi.status AS {0}".format\(STATUS\), "t.effectiveFlagged", "t.dateModified AS {0}".format\(MODIFIED\_DATE\), "t.containingProjectInfo AS {0}".format\(CONTAINING\_PROJECT\_INFO\), "t.dateDue AS {0}".format\(DUE\_DATE\) \]\) + ", t.effectiveContainingProjectInfoRemaining AS {0}".format\(PROJECT\_IS\_REMAINING\) TASK\_FROM = \("\(\(task tt left join projectinfo pi on tt.containingprojectinfo=pi.pk\) t left join " "task p on t.task=p.persistentIdentifier\) "\) TASK\_WHERE = "\(t.containingProjectInfo &lt;&gt; t.persistentIdentifier OR t.containingProjectInfo is NULL\) " TASK\_NAME\_WHERE = "t.dateCompleted IS NULL AND lower\(t.name\) LIKE lower\('%{0}%'\) AND " NOT\_COMPLETED\_CLAUSE = "t.dateCompleted IS NULL AND t.effectiveContainingProjectInfoRemaining = 1" ACTIVE\_CLAUSE = "t.blocked = 0 AND " TAG\_SELECT = ", ".join\(\[ "persistentIdentifier AS {0}".format\(ID\), "name AS {0}".format\(NAME\), "allowsNextAction AS {0}".format\(ALLOWS\_NEXT\_ACTION\)\]\) + ", availableTaskCount AS {0}".format\(AVAILABLE\_TASK\_COUNT\) PROJECT\_SELECT = ", ".join\(\[ "p.pk AS {0}".format\(ID\), "t.name AS {0}".format\(NAME\), "p.status AS {0}".format\(STATUS\), "p.numberOfAvailableTasks AS {0}".format\(AVAILABLE\_TASK\_COUNT\), "p.numberOfRemainingTasks AS {0}".format\(REMAINING\_TASK\_COUNT\), "p.containsSingletonActions AS {0}".format\(SINGLETON\), "f.name AS {0}".format\(FOLDER\_NAME\), "t.dateToStart AS {0}".format\(START\_DATE\)\]\) + ", t.effectiveDateToStart AS {0}".format\(EFFECTIVE\_START\_DATE\) OF2\_DUE\_SOON\_CONSTRAINT = " AND \(t.isDueSoon or t.isOverdue\)" OF3\_DUE\_SOON\_CONSTRAINT = " AND \(t.dueSoon or t.overdue\)" def search\_tasks\(active\_only, flagged, query, everything=None\): where = \(TASK\_NAME\_WHERE + TASK\_WHERE\).format\(query\) if active\_only: where = "\(t.blocked = 0 AND t.blockedByFutureStartDate = 0\) AND " + where if flagged: where = "\(t.flagged = 1 OR t.effectiveFlagged = 1\) AND " + where if not everything: where = "\(t.effectiveInInbox = 0 AND t.inInbox = 0\) AND " + where return \_generate\_query\(TASK\_SELECT, TASK\_FROM, where, "t." + NAME\_SORT\) def search\_inbox\(query\): where = "\(t.effectiveInInbox = 1 OR t.inInbox = 1\)" if query: where = \(TASK\_NAME\_WHERE + where\).format\(query\) return \_generate\_query\(TASK\_SELECT, TASK\_FROM, where, "t." + NAME\_SORT\) def search\_projects\(active\_only, query\): from\_ = \("\(ProjectInfo p LEFT JOIN Task t ON p.task=t.persistentIdentifier\) " "LEFT JOIN Folder f ON p.folder=f.persistentIdentifier"\) where = "lower\(t.name\) LIKE lower\('%{0}%'\)".format\(query\) order\_by = "p.containsSingletonActions DESC, t.name ASC" if active\_only: where = "p.status = 'active' AND " + where return \_generate\_query\(PROJECT\_SELECT, from\_, where, order\_by\) def search\_tags\(query\): if not query: return "SELECT {0} FROM {1} ORDER BY {2}".format\(TAG\_SELECT, "Context", NAME\_SORT\) else: where = "lower\(name\) LIKE lower\('%{0}%'\)".format\(query\) return \_generate\_query\(TAG\_SELECT, "Context", where, NAME\_SORT\) def search\_folders\(query\): select = "persistentIdentifier AS {0}, name as {1}".format\(ID, NAME\) where = "\(dateHidden is null AND effectiveDateHidden is null\)" if query: where = where + " AND lower\(name\) LIKE lower\('%{0}%'\)".format\(query\) return \_generate\_query\(select, "Folder", where, NAME\_SORT\) def search\_notes\(active\_only, flagged, query\): select = TASK\_SELECT + ", t.plainTextNote" where = "t.dateCompleted IS NULL AND lower\(t.plainTextNote\) LIKE lower\('%{0}%'\)".format\(query\) if active\_only: where = where + " AND \(t.blocked = 0 AND t.blockedByFutureStartDate = 0\)" if flagged: where = where + " AND \(t.flagged = 1 OR t.effectiveFlagged = 1\)" return \_generate\_query\(select, TASK\_FROM, where, "t." + NAME\_SORT\) def show\_recent\_tasks\(active\_only\): if active\_only: return \_generate\_query\(TASK\_SELECT, TASK\_FROM, NOT\_COMPLETED\_CLAUSE, "t.dateModified DESC"\) + " LIMIT 10" else: return "SELECT {0} FROM {1} ORDER BY {2} LIMIT {3}".format\(TASK\_SELECT, TASK\_FROM, "t.dateModified DESC", 10\) def show\_due\_tasks\(\): return \_generate\_query\(TASK\_SELECT, TASK\_FROM, NOT\_COMPLETED\_CLAUSE + OF3\_DUE\_SOON\_CONSTRAINT, "t.dateDue ASC"\) + " LIMIT 10" def \_generate\_query\(select, from\_, where, order\_by\): return "SELECT {0} FROM {1} WHERE {2} ORDER BY {3}".format\(select, from\_, where, order\_by\)

