# rhydlewis/search-omnifocus

 from \_\_future\_\_ import unicode\_literals import sqlite3 import sys import os import argparse import datetime from workflow import Workflow, ICON\_WARNING, ICON\_SYNC from factory import Factory import queries import omnifocus VERSION\_KEY = 'of\_version' DB\_KEY = 'db\_path' ICON\_ROOT = 'icon\_path' OF3\_DB\_LOCATION = "/Library/Group Containers/34YW5XSRB7.com.omnigroup.OmniFocus/com.omnigroup.OmniFocus3/" \ "com.omnigroup.OmniFocusModel/OmniFocusDatabase.db" OF3\_MAS\_DB\_LOCATION = OF3\_DB\_LOCATION.replace\('.OmniFocus3', '.OmniFocus3.MacAppStore'\) OF\_ICON\_ROOT = '/Applications/OmniFocus.app/Contents/Resources' \# Update workflow from GitHub repo UPDATE\_SETTINGS = {'github\_slug': 'rhydlewis/search-omnifocus'} SHOW\_UPDATES = True TASK = "t" INBOX = "i" PROJECT = "p" CONTEXT = "c" PERSPECTIVE = "v" FOLDER = "f" FLAGGED = "g" NOTES = "n" RECENT = "r" DUE = "d" log = None SINGLE\_QUOTE = "'" ESC\_SINGLE\_QUOTE = "''" def main\(wf\): log.debug\('Started workflow'\) args = parse\_args\(\) if SHOW\_UPDATES and workflow.update\_available: wf.add\_item\('A new version is available', 'Action this item to install the update', autocomplete='workflow:update', icon=ICON\_SYNC\) factory = Factory\(find\_omnifocus\_icons\(\)\) if args.type != PERSPECTIVE: sql = populate\_query\(args\) get\_results\(sql, args.type, factory\) else: get\_perspectives\(args, factory\) wf.send\_feedback\(\) def get\_results\(sql, query\_type, factory\): workflow.logger.debug\(sql\) results = run\_query\(sql\) if not results: workflow.add\_item\('No items', icon=ICON\_WARNING\) else: for result in results: if query\_type == PROJECT: item = factory.create\_project\(result\) elif query\_type == CONTEXT: item = factory.create\_context\(result\) elif query\_type == FOLDER: item = factory.create\_folder\(result\) elif query\_type == RECENT: item = factory.create\_recent\_item\(result\) else: item = factory.create\_task\(result\) log.debug\(item\) workflow.add\_item\(title=item.name, subtitle=item.subtitle, icon=item.icon, arg=item.persistent\_id, valid=True\) def get\_perspectives\(args, factory\): if args.query: query = args.query\[0\] log.debug\("Searching perspectives for '{0}'".format\(query\)\) perspectives = omnifocus.search\_perspectives\(query\) else: log.debug\("Finding all perspectives"\) perspectives = omnifocus.list\_perspectives\(\) if not perspectives: workflow.add\_item\('No items', icon=ICON\_WARNING\) else: for perspective in perspectives: log.debug\(perspective\) item = factory.create\_perspective\(perspective\) log.debug\(item\) workflow.add\_item\(title=item.name, subtitle=item.subtitle, icon=item.icon, arg=item.name, valid=True\) def populate\_query\(args\): query = None if args.query: query = args.query\[0\] if SINGLE\_QUOTE in query: query = query.replace\(SINGLE\_QUOTE, ESC\_SINGLE\_QUOTE\) active\_only = args.active\_only flagged\_only = args.flagged\_only everything = args.everything if args.type == PROJECT: log.debug\('Searching projects'\) sql = queries.search\_projects\(active\_only, query\) elif args.type == CONTEXT: log.debug\('Searching contexts/tags'\) sql = queries.search\_tags\(query\) elif args.type == FOLDER: log.debug\('Searching folder'\) sql = queries.search\_folders\(query\) elif args.type == INBOX: log.debug\('Searching inbox'\) sql = queries.search\_inbox\(query\) elif args.type == NOTES: log.debug\('Searching inbox'\) sql = queries.search\_notes\(active\_only, flagged\_only, query\) elif args.type == RECENT: log.debug\('Searching recent items'\) sql = queries.show\_recent\_tasks\(active\_only\) elif args.due: log.debug\('Listing overdue or due items'\) sql = queries.show\_due\_tasks\(\) else: log.debug\('Searching tasks'\) sql = queries.search\_tasks\(active\_only, flagged\_only, query, everything\) return sql def parse\_args\(\): parser = argparse.ArgumentParser\(description="Search OmniFocus"\) parser.add\_argument\('-a', '--active-only', action='store\_true', help='search for active tasks only'\) parser.add\_argument\('-g', '--flagged-only', action='store\_true', help='search for flagged tasks only'\) parser.add\_argument\('-e', '--everything', action='store\_true', help='search for tasks in the inbox as well as processed tasks'\) parser.add\_argument\('-t', '--type', default=TASK, choices=\[INBOX, TASK, PROJECT, CONTEXT, PERSPECTIVE, FOLDER, NOTES, RECENT\], type=str, help='What to search for: \(b\)oth tasks and projects, \(t\)ask, ' '\(p\)roject, \(c\)ontext, \(f\)older, perspecti\(v\)e, ' 'task \(n\)otes or \(r\)ecent items?'\) parser.add\_argument\('-d', '--due', action='store\_true', help='show overdue or due items'\) parser.add\_argument\('query', type=unicode, nargs=argparse.REMAINDER, help='query string'\) log.debug\(workflow.args\) args = parser.parse\_args\(workflow.args\) return args def find\_omnifocus\_icons\(\): if ICON\_ROOT not in workflow.settings.keys\(\): icon\_root = OF\_ICON\_ROOT if not os.path.isdir\(icon\_root\): icon\_root = omnifocus.find\_install\_location\(\) + "Contents/Resources" workflow.settings\[ICON\_ROOT\] = icon\_root log.debug\("Storing icon\_root as '{0}'".format\(icon\_root\)\) else: icon\_root = workflow.settings\[ICON\_ROOT\] log.debug\("Using stored icon\_root:'{0}'".format\(icon\_root\)\) return icon\_root def find\_omnifocus\_db\(\): home = os.path.expanduser\("~"\) db = "{0}{1}".format\(home, OF3\_DB\_LOCATION\) mas = "{0}{1}".format\(home, OF3\_MAS\_DB\_LOCATION\) if not os.path.isfile\(db\): log.debug\("OmniFocus db not found at {0}; using {1} instead".format\(db, mas\)\) db = mas elif os.path.isfile\(mas\): db\_mod = mod\_date\(db\) mas\_mod = mod\_date\(mas\) if db\_mod &lt; mas\_mod: db = mas log.debug\("OmniFocus direct and MAS db's found; using {0} as it's newer " "\(Direct {1} vs. MAS {2}\)".format\(db, db\_mod, mas\_mod\)\) log.debug\(db\) return db def mod\_date\(filename\): mtime = os.path.getmtime\(filename\) return datetime.datetime.fromtimestamp\(mtime\) def run\_query\(sql\): db\_path = find\_omnifocus\_db\(\) conn = sqlite3.connect\(db\_path\) conn.row\_factory = sqlite3.Row cursor = conn.cursor\(\) log.debug\(sql\) cursor.execute\(sql\) results = cursor.fetchall\(\) log.debug\("Found {0} results".format\(len\(results\)\)\) cursor.close\(\) return results if \_\_name\_\_ == '\_\_main\_\_': workflow = Workflow\(update\_settings=UPDATE\_SETTINGS\) log = workflow.logger sys.exit\(workflow.run\(main\)\)

